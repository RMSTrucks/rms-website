---
interface Props {
  state?: string;
  title?: string;
}

const { state, title = "Get Your Commercial Truck Insurance Quote" } = Astro.props;
const stateText = state ? ` ${state}` : "";
---

<section class="quote-section" id="quote">
  <div class="container">
    <div class="quote-layout">
      <div class="quote-info">
        <span class="section-tag">Get Started</span>
        <h2>{title}</h2>
        <p>RMS Truck Insurance provides same-day quotes for owner-operators and new authorities{stateText ? ` in${stateText}` : ""}. Licensed in 40+ states. Call 208-800-0640 or complete the form below.</p>
        <ul class="quote-benefits">
          <li>No obligation quote</li>
          <li>We explain everything</li>
          <li>Same day response</li>
        </ul>
        <p class="quote-alt">Or call/text: <a href="tel:208-800-0640">208-800-0640</a></p>
      </div>

      <form class="quote-form" action="https://formspree.io/f/YOUR_FORM_ID" method="POST" novalidate>
        {state && <input type="hidden" name="state_page" value={state} />}
        <div class="form-row">
          <div class="form-field">
            <label for="name">Your Name <span class="required">*</span></label>
            <input type="text" id="name" name="name" required placeholder="John Smith" autocomplete="name">
            <span class="field-error"></span>
          </div>
          <div class="form-field">
            <label for="phone">Phone <span class="required">*</span></label>
            <input type="tel" id="phone" name="phone" required placeholder="(555) 123-4567" autocomplete="tel">
            <span class="field-error"></span>
          </div>
        </div>
        <div class="form-row">
          <div class="form-field">
            <label for="email">Email <span class="required">*</span></label>
            <input type="email" id="email" name="email" required placeholder="john@example.com" autocomplete="email">
            <span class="field-error"></span>
          </div>
          <div class="form-field">
            <label for="dot">USDOT# <span class="optional">(optional)</span></label>
            <input type="text" id="dot" name="usdot" placeholder="1234567" inputmode="numeric" pattern="[0-9]*">
            <span class="field-error"></span>
          </div>
        </div>
        <div class="form-field">
          <label for="trucks">Number of Trucks <span class="required">*</span></label>
          <select id="trucks" name="truck_count" required>
            <option value="">Select...</option>
            <option value="1">1 truck</option>
            <option value="2-3">2-3 trucks</option>
            <option value="4-10">4-10 trucks</option>
            <option value="10+">10+ trucks</option>
          </select>
          <span class="field-error"></span>
        </div>
        <div class="form-field">
          <label for="message">Message <span class="optional">(optional)</span></label>
          <textarea id="message" name="message" rows="3" placeholder="What you haul, when you need coverage..."></textarea>
        </div>
        <button type="submit" class="btn-submit">
          <span class="btn-text">Get My{stateText} Quote</span>
          <span class="btn-loading" style="display:none;">Sending...</span>
        </button>
        <div class="form-message" style="display:none;"></div>
      </form>
    </div>
  </div>
</section>

<style>
  .quote-section {
    padding: 6rem 0;
    background: var(--forest-deep, #0D2118);
    color: var(--white, #ffffff);
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 2rem;
  }

  .section-tag {
    display: inline-block;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--gold, #DAA520);
    margin-bottom: 1rem;
  }

  .quote-layout {
    display: grid;
    grid-template-columns: 1fr 1.5fr;
    gap: 4rem;
    align-items: start;
  }

  .quote-info h2 {
    font-size: clamp(2rem, 4vw, 2.5rem);
    margin-bottom: 1rem;
  }

  .quote-info > p {
    opacity: 0.8;
    margin-bottom: 1.5rem;
  }

  .quote-benefits {
    list-style: none;
    padding: 0;
    margin: 0 0 1.5rem 0;
  }

  .quote-benefits li {
    padding: 0.5rem 0;
    padding-left: 1.5rem;
    position: relative;
    opacity: 0.8;
  }

  .quote-benefits li::before {
    content: '\2713';
    position: absolute;
    left: 0;
    color: var(--gold, #DAA520);
  }

  .quote-alt a {
    color: var(--gold, #DAA520);
    font-weight: 600;
  }

  .quote-form {
    background: rgba(255,255,255,0.05);
    padding: 2rem;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.1);
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  .form-field {
    margin-bottom: 1rem;
  }

  .form-field label {
    display: block;
    font-size: 0.85rem;
    margin-bottom: 0.5rem;
    opacity: 0.9;
  }

  .form-field input,
  .form-field select,
  .form-field textarea {
    width: 100%;
    padding: 10px 14px;
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 4px;
    color: var(--white, #ffffff);
    font-size: 1rem;
    font-family: inherit;
  }

  .form-field input::placeholder,
  .form-field textarea::placeholder {
    color: rgba(255,255,255,0.4);
  }

  .form-field input:focus,
  .form-field select:focus,
  .form-field textarea:focus {
    outline: none;
    border-color: var(--gold, #DAA520);
  }

  .form-field select option {
    background: var(--forest, #1B4332);
  }

  .btn-submit {
    width: 100%;
    padding: 14px;
    background: var(--gold, #DAA520);
    color: var(--forest, #1B4332);
    font-size: 1rem;
    font-weight: 600;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .btn-submit:hover {
    background: var(--white, #ffffff);
  }

  .btn-submit:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .btn-submit .btn-loading {
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  .btn-submit .btn-loading::after {
    content: '';
    width: 16px;
    height: 16px;
    border: 2px solid var(--forest, #1B4332);
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .form-field .required {
    color: #ef4444;
    font-weight: 500;
  }

  .form-field .optional {
    color: rgba(255,255,255,0.4);
    font-size: 0.8rem;
    font-weight: 400;
  }

  .field-error {
    display: block;
    color: #ef4444;
    font-size: 0.8rem;
    margin-top: 4px;
    min-height: 1.2em;
  }

  .form-field.has-error input,
  .form-field.has-error select,
  .form-field.has-error textarea {
    border-color: #ef4444;
  }

  .form-message {
    margin-top: 12px;
    padding: 12px 16px;
    border-radius: 4px;
    font-size: 0.95rem;
    text-align: center;
  }

  .form-message.success {
    background: #e8f5e9;
    color: #2e7d32;
  }

  .form-message.error {
    background: #fbe9e7;
    color: #c62828;
  }

  @media (max-width: 968px) {
    .quote-layout {
      grid-template-columns: 1fr;
      gap: 2rem;
    }

    .form-row {
      grid-template-columns: 1fr;
    }
  }
</style>

<script is:inline>
  // Form validation and submission for quote forms
  document.querySelectorAll('.quote-form').forEach(function(quoteForm) {
    // Track form start (first field focus)
    let formStarted = false;
    quoteForm.querySelectorAll('input, select, textarea').forEach(function(field) {
      field.addEventListener('focus', function() {
        if (!formStarted && typeof gtag !== 'undefined') {
          formStarted = true;
          gtag('event', 'form_start', {
            'event_category': 'engagement',
            'event_label': 'quote_form'
          });
        }
      });
    });

    // Validation rules
    const validators = {
      name: function(value) {
        if (!value.trim()) return 'Name is required';
        if (value.trim().length < 2) return 'Please enter your full name';
        return '';
      },
      phone: function(value) {
        if (!value.trim()) return 'Phone is required';
        var cleaned = value.replace(/[\s\-\(\)\+]/g, '');
        if (!/^\d{10,}$/.test(cleaned)) return 'Please enter a valid phone number';
        return '';
      },
      email: function(value) {
        if (!value.trim()) return 'Email is required';
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) return 'Please enter a valid email';
        return '';
      },
      trucks: function(value) {
        if (!value) return 'Please select truck count';
        return '';
      },
      dot: function(value) {
        if (value && !/^\d+$/.test(value)) return 'USDOT should be numbers only';
        return '';
      }
    };

    // Clear error on input
    quoteForm.querySelectorAll('input, select, textarea').forEach(function(field) {
      field.addEventListener('input', function() {
        var wrapper = this.closest('.form-field');
        wrapper.classList.remove('has-error');
        wrapper.querySelector('.field-error').textContent = '';
      });
    });

    // Validate single field
    function validateField(field) {
      var name = field.id;
      var validator = validators[name];
      if (!validator) return true;

      var error = validator(field.value);
      var wrapper = field.closest('.form-field');
      var errorEl = wrapper.querySelector('.field-error');

      if (error) {
        wrapper.classList.add('has-error');
        errorEl.textContent = error;
        return false;
      } else {
        wrapper.classList.remove('has-error');
        errorEl.textContent = '';
        return true;
      }
    }

    // Validate all fields
    function validateForm() {
      var isValid = true;
      var firstError = null;

      ['name', 'phone', 'email', 'trucks', 'dot'].forEach(function(fieldId) {
        var field = quoteForm.querySelector('#' + fieldId);
        if (field && !validateField(field)) {
          isValid = false;
          if (!firstError) firstError = field;
        }
      });

      if (firstError) firstError.focus();
      return isValid;
    }

    // Handle submission
    quoteForm.addEventListener('submit', function(e) {
      e.preventDefault();

      if (!validateForm()) return;

      var btn = quoteForm.querySelector('.btn-submit');
      var btnText = btn.querySelector('.btn-text');
      var btnLoading = btn.querySelector('.btn-loading');
      var msg = quoteForm.querySelector('.form-message');

      btn.disabled = true;
      btnText.style.display = 'none';
      btnLoading.style.display = 'inline-flex';
      msg.style.display = 'none';

      // Track submission
      if (typeof gtag !== 'undefined') {
        gtag('event', 'quote_form_submit', {
          'event_category': 'conversion',
          'event_label': 'quote_request'
        });
      }

      // Submit to Formspree
      fetch(quoteForm.action, {
        method: 'POST',
        body: new FormData(quoteForm),
        headers: { 'Accept': 'application/json' }
      })
      .then(function(res) {
        if (res.ok) {
          msg.textContent = "Got it! We'll call you shortly.";
          msg.className = 'form-message success';
          msg.style.display = 'block';
          quoteForm.reset();

          if (typeof gtag !== 'undefined') {
            gtag('event', 'quote_form_success', {
              'event_category': 'conversion',
              'event_label': 'quote_request_complete'
            });
          }
        } else {
          throw new Error('Submission failed');
        }
      })
      .catch(function() {
        msg.textContent = 'Something went wrong. Call us at 208-800-0640.';
        msg.className = 'form-message error';
        msg.style.display = 'block';
      })
      .finally(function() {
        btn.disabled = false;
        btnText.style.display = 'inline';
        btnLoading.style.display = 'none';
      });
    });
  });
</script>
